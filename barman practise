Configure Repo:
sudo apt install curl ca-certificates
sudo install -d /usr/share/postgresql-common/pgdg
sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc
--fail https://www.postgresql.org/media/keys/ACCC4CF8.asc
sudo sh -c 'echo "deb
[signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc]
https://apt.postgresql.org/pub/repos/apt $(lsb
_
release -cs)-pgdg main" >
/etc/apt/sources.list.d/pgdg.list'
sudo apt update

Backup Node:
# install barman and barman-cli on backup server
sudo apt -y install barman barman-cli

DB Node:
# install pg, barman and barman-cli on dbserver
sudo apt -y install postgresql-16 barman barman-cli

================================
On Backup Node:
sudo vi /etc/barman.conf
[barman]
; the system user who will own the files with backups and run backups
barman_user = barman
; directory with additional configuration files for individual servers
configuration_files_directory = /etc/barman.d
; directory where all backups will be stored
barman_home = /var/lib/barman
; location where the log file will be saved
log_file = /var/log/barman/barman.log
; login level
log_level = INFO
; minimum required number of backups
minimum_redundancy = 2

neha.korukula@barman-backup-node:~$ sudo cat /etc/barman.d/streaming-pg-5432.conf
; alias/name of the server that will be backed up
[streaming-pg-5432]
; definition of the server and user who will check the cluster during the backup
conninfo = host=10.30.50.91 user=barman dbname=postgres
; connection definition for streaming backups
streaming_conninfo = host=10.30.50.91 user=streaming_barman
; backup method, postgres/rsync
backup_method = postgres
; enabling WAL file streaming
streaming_archiver = on
; name of the physical replication slot used for archiving
slot_name = barman
; should the barman automatically try to create a slot if it does not exist?
create_slot = auto
; !! on RHEL family servers, or if we need to create backups for different versions of Postgres
; we add the path to the Postgres executable files in the version corresponding to the dbserver version
path_prefix = /usr/lib/postgresql/16/bin/


Steps to be performed on db server:

echo "#/etc/postgresql/16/main/conf.d/barman.conf

# specifying which network interfaces postgres should listen on
# '*' listens on all network interfaces
listen_addresses = '*'
# maximum number of processes streaming WAL entries, default 10
max_wal_senders = 5
# maximum number of replication slots, default 10
max_replication_slots = 5
# logging level: minimal, replica, logical. To enable playback to
# selected point in time, we must choose replica or logical. Minimal allows
# only to restore data to a consistent state after an unexpected termination
# to the postgres process
wal_level = replica
# redu mto the log instead of to the console
# on Ubuntu it is disabled by default, on RHEL it is enabled
logging_collector = on

" | sudo tee /etc/postgresql/16/main/conf.d/barman.conf

 sudo systemctl restart postgresql@16-main.service 

 sudo -iu postgres psql -c "create user streaming_barman with replication password 'barman123'";
 sudo -iu postgres psql -c "create user barman with password 'barman123'";
sudo -iu postgres psql -d postgres -c "CREATE DATABASE barman_test;"

For PG versions 15 and +
sudo -iu postgres psql -c "GRANT EXECUTE ON FUNCTION pg_backup_start(text, boolean) to barman;"
sudo -iu postgres psql -c "GRANT EXECUTE ON FUNCTION pg_backup_stop(boolean) to barman;"
sudo -iu postgres psql -c "GRANT EXECUTE ON FUNCTION pg_switch_wal() to barman;"
sudo -iu postgres psql -c "GRANT EXECUTE ON FUNCTION pg_create_restore_point(text) to barman;"
sudo -iu postgres psql -c "GRANT pg_read_all_settings TO barman;"
sudo -iu postgres psql -c "GRANT pg_read_all_stats TO barman;"

For PG Versions until 14
sudo -iu postgres psql -c "GRANT EXECUTE ON FUNCTION pg_start_backup(text, boolean, boolean) to barman;"
sudo -iu postgres psql -c "GRANT EXECUTE ON FUNCTION pg_stop_backup() to barman;"
sudo -iu postgres psql -c "GRANT EXECUTE ON FUNCTION pg_stop_backup(boolean, boolean) to barman;"
sudo -iu postgres psql -c "GRANT EXECUTE ON FUNCTION pg_switch_wal() to barman;"
sudo -iu postgres psql -c "GRANT EXECUTE ON FUNCTION pg_create_restore_point(text) to barman;"
sudo -iu postgres psql -c "GRANT pg_read_all_settings TO barman;"
sudo -iu postgres psql -c "GRANT pg_read_all_stats TO barman;"

pg_hba.conf setup:

echo "

#Allowing replication & barman user connections
host replication streaming_barman 10.30.50.90/32 scram-sha-256
host postgres    barman           10.30.50.90/32 scram-sha-256
" | sudo tee -a /etc/postgresql/16/main/pg_hba.conf

sudo -iu postgres psql -d postgres -c "select pg_reload_conf();"

On Backup server:
As barman user:
cat <<EOF > ~barman/.pgpass
10.30.50.91:5432:*:barman:barman123
10.30.50.91:5432:*:streaming_barman:barman123
EOF
chmod 600 ~barman/.pgpass

Validate connectivity from backup node:
barman@barman-backup-node:~$  psql -U barman -h 10.30.50.91 postgres -c "select now()"
              now              
-------------------------------
 2025-12-13 00:34:13.906757+00
(1 row)

Attempt to initialize replication by the streaming_barman user
sudo -iu postgres psql -U streaming_barman -h 10.30.50.91 -c "IDENTIFY_SYSTEM" replication=1
neha.korukula@barman-backup-node:~$ sudo -iu barman psql -U streaming_barman -h 10.30.50.91 -c "IDENTIFY_SYSTEM" replication=1
      systemid       | timeline |  xlogpos  | dbname 
---------------------+----------+-----------+--------
 7583104103457713453 |        1 | 0/19606E0 | 
(1 row)

Check the backup status:
neha.korukula@barman-backup-node:~$ sudo -iu barman barman check streaming-pg-5432
Server streaming-pg-5432:
	WAL archive: FAILED (please make sure WAL shipping is setup)
	PostgreSQL: OK
	no access to backup functions: FAILED (privileges for PostgreSQL backup functions are required (see documentation))
	PostgreSQL streaming: OK
	wal_level: OK
	replication slot: OK
	directories: OK
	retention policy settings: OK
	backup maximum age: OK (no last_backup_maximum_age provided)
	backup minimum size: OK (0 B)
	wal maximum age: OK (no last_wal_maximum_age provided)
	wal size: OK (0 B)
	compression settings: OK
	failed backups: OK (there are 0 failed backups)
	minimum redundancy requirements: FAILED (have 0 backups, expected at least 2)
	pg_basebackup: OK
	pg_basebackup compatible: OK
	pg_basebackup supports tablespaces mapping: OK
	systemid coherence: OK (no system Id stored on disk)
	pg_receivexlog: OK
	pg_receivexlog compatible: OK
	receive-wal running: OK
	archiver errors: OK

  Error:
  neha.korukula@barman-backup-node:~$ sudo -iu barman barman switch-wal --archive --archive-timeout 60 streaming-pg-5432
EXCEPTION: Postgres user 'barman' is missing required privileges (see "Preliminary steps" in the Barman manual)
See log file for more details.

neha.korukula@barman-backup-node:~$ sudo -iu barman barman switch-wal --archive --archive-timeout 60 streaming-pg-5432
The WAL file 000000010000000000000001 has been closed on server 'streaming-pg-5432'
Waiting for the WAL file 000000010000000000000001 from server 'streaming-pg-5432' (max: 60 seconds)
Processing xlog segments from streaming for streaming-pg-5432
	000000010000000000000001

  neha.korukula@barman-backup-node:~$ sudo -iu barman barman check streaming-pg-5432
Server streaming-pg-5432:
	PostgreSQL: OK
	superuser or standard user with backup privileges: OK
	PostgreSQL streaming: OK
	wal_level: OK
	replication slot: OK
	directories: OK
	retention policy settings: OK
	backup maximum age: OK (no last_backup_maximum_age provided)
	backup minimum size: OK (0 B)
	wal maximum age: OK (no last_wal_maximum_age provided)
	wal size: OK (0 B)
	compression settings: OK
	failed backups: OK (there are 0 failed backups)
	minimum redundancy requirements: FAILED (have 0 backups, expected at least 2)
	pg_basebackup: OK
	pg_basebackup compatible: OK
	pg_basebackup supports tablespaces mapping: OK
	systemid coherence: OK (no system Id stored on disk)
	pg_receivexlog: OK
	pg_receivexlog compatible: OK
	receive-wal running: OK
	archiver errors: OK

Command to trigger backup
barman backup streaming-pg-5432 --wait

--wait switch to make the barman wait for the WAL files needed to recover a consistent version
of the data
neha.korukula@barman-backup-node:~$ sudo -iu barman barman backup streaming-pg-5432 --wait
Starting backup using postgres method for server streaming-pg-5432 in /var/lib/barman/streaming-pg-5432/base/20251213T004509
Backup start at LSN: 0/2000060 (000000010000000000000002, 00000060)
Starting backup copy via pg_basebackup for 20251213T004509
WARNING: pg_basebackup does not copy the PostgreSQL configuration files that reside outside PGDATA. Please manually backup the following files:
	/etc/postgresql/16/main/postgresql.conf
	/etc/postgresql/16/main/pg_hba.conf
	/etc/postgresql/16/main/pg_ident.conf
	/etc/postgresql/16/main/conf.d/barman.conf

Copy done (time: 3 seconds)
Finalising the backup.
This is the first backup for server streaming-pg-5432
WAL segments preceding the current backup have been found:
	000000010000000000000001 from server streaming-pg-5432 has been removed
Backup size: 29.6 MiB
Backup end at LSN: 0/4000000 (000000010000000000000003, 00000000)
Backup completed (start time: 2025-12-13 00:45:09.717102, elapsed time: 3 seconds)
Waiting for the WAL file 000000010000000000000003 from server 'streaming-pg-5432'
Processing xlog segments from streaming for streaming-pg-5432
	000000010000000000000002
	000000010000000000000003

Note :
Barman always makes a full backup when backing up in streaming mode. This is
because a streaming backup is actually pg_
basebackup, which does not have the ability to
perform differential backups or use other backups as a backup source. This has changed in the
latest Barman release when used for PG17+.

List backups:
neha.korukula@barman-backup-node:~$ sudo -iu barman barman list-backup streaming-pg-5432
streaming-pg-5432 20251213T004509 - Sat Dec 13 00:45:13 2025 - Size: 45.6 MiB - WAL Size: 0 B

# delete a specific backup
barman delete <server_name> <backup_name> 
# delete the oldest backup
barman delete <server_name> oldest 

The "delete oldest" command resulted in the barman deleting the backup along with all its associated WAL
files from the archive that are not required by any of the other backups.

=========================
Backup Retentions:

retention_policy
minimum_redundancy

minimum_redundancy = No. of backups to be kept.
retention_policy = {REDUNDANCY value | RECOVERY WINDOW OF value {DAYS | WEEKS | MONTHS}}

Note: The “delete oldest” command does not check policy settings; the only parameter that is important to it is minimum_redundancy.

Eg: retention_policy = REDUNDANCY 3

neha.korukula@barman-backup-node:~$ sudo -iu barman barman list-backup streaming-pg-5432
streaming-pg-5432 20251215T220828 - Mon Dec 15 22:08:29 2025 - Size: 45.6 MiB - WAL Size: 0 B
streaming-pg-5432 20251215T220823 - Mon Dec 15 22:08:24 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB
streaming-pg-5432 20251215T220800 - Mon Dec 15 22:08:01 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB
streaming-pg-5432 20251215T220740 - Mon Dec 15 22:07:41 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB - OBSOLETE
streaming-pg-5432 20251215T220738 - Mon Dec 15 22:07:39 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB - OBSOLETE

Marks the rest of backups obselete as per retention_policy.
-> All the unnecessary backups can be deleted by barman cron.

neha.korukula@barman-backup-node:~$ sudo -iu barman barman list-backup streaming-pg-5432
streaming-pg-5432 20251215T221152 - Mon Dec 15 22:11:53 2025 - Size: 45.6 MiB - WAL Size: 0 B
streaming-pg-5432 20251215T221149 - Mon Dec 15 22:11:50 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB
streaming-pg-5432 20251215T221047 - Mon Dec 15 22:10:47 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB
streaming-pg-5432 20251215T220828 - Mon Dec 15 22:08:29 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB - OBSOLETE
streaming-pg-5432 20251215T220823 - Mon Dec 15 22:08:24 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB - OBSOLETE
neha.korukula@barman-backup-node:~$ sudo -iu barman barman cron
Starting WAL archiving for server streaming-pg-5432
neha.korukula@barman-backup-node:~$ sudo -iu barman barman list-backup streaming-pg-5432
streaming-pg-5432 20251215T221152 - Mon Dec 15 22:11:53 2025 - Size: 45.6 MiB - WAL Size: 0 B
streaming-pg-5432 20251215T221149 - Mon Dec 15 22:11:50 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB
streaming-pg-5432 20251215T221047 - Mon Dec 15 22:10:47 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB

It is recommended that the “barman cron” command be added to the barman user's crontab and run every
minute to ensure that all changes from WAL files have been archived and compressed and that copies that
we no longer need have been deleted.

# open crontab in a text editor for user Barman
crontab -e
# add the line below and save
* * * * * /usr/bin/barman cron

For newer versions , its already added to cron.
neha.korukula@barman-backup-node:~$ cat /etc/cron.d/barman
# /etc/cron.d/barman: crontab entries for the barman package
MAILTO=root
* * * * * barman [ -x /usr/bin/barman ] && /usr/bin/barman -q cron

==================================================================
Barman PIT restore:

Barman allows us to very easily restore the database 
to any place in time (--target-time), 
to any transaction (--target-xid), 
to a selected sequence in the log (--target-lsn), 
to a previously created restore point (--target-name) or 
simply until the first moment when the database has consistent data (--target-immediate).

**We can recover data locally or to a remote server

Test case:

create table random_people as
  with rnd_people as (
    select distinct  
            ('[0:9]={"Daniele","Debora","Mattia","Jake","Amy","Henry","Neil","Tim","John","George"}'::text[])
                    [floor(random()*10)] first_name,
            ('[0:9]={"Rossi","Verdi","Gialli","Caponi","Gallini","Gatti","Ford","Daniel","Harrison","Macdonald"}'::text[])
                    [floor(random()*10)] last_name
    from 
      generate_series(1, 10 * 10 * 50)
  )
  select 
    row_number() over() id, first_name, last_name 
  from 
    rnd_people;

barman_test=# select now();
              now              
-------------------------------
 2025-12-15 23:13:53.866517+00
(1 row)

with rnd_people as (
    select distinct  
            ('[0:9]={"Daniele","Debora","Mattia","Jake","Amy","Henry","Neil","Tim","John","George"}'::text[])
                    [floor(random()*10)] first_name,
            ('[0:9]={"Rossi","Verdi","Gialli","Caponi","Gallini","Gatti","Ford","Daniel","Harrison","Macdonald"}'::text[])
                    [floor(random()*10)] last_name
    from 
      generate_series(1, 10 * 10 * 50)
)
INSERT INTO random_people (id, first_name, last_name) 
select 
    row_number() over() id, first_name, last_name 
  from 
    rnd_people;
barman_test=# select now();
              now              
-------------------------------
 2025-12-15 23:24:06.414454+00
(1 row)

we need to set up a passwordless SSH connection. To do this, you need to generate RSA keys on the postgres server as the postgres user and on the
barman server as the barman user.

ssh barman@postgres DB server
ssh postgres @barman backup server

2025-12-15 23:13:53.866517+00

Restore from backup node:
barman recover streaming-pg-5432 20251215T221047 /var/lib/postgresql/16/test_restore --remote-ssh-command "ssh postgres@10.30.50.91" --target-time "2025-12-15 23:13:53.866517+00:00" --get-wal

neha.korukula@barman-backup-node:~$ sudo -iu barman barman list-backup streaming-pg-5432
streaming-pg-5432 20251215T221152 - Mon Dec 15 22:11:53 2025 - Size: 45.6 MiB - WAL Size: 0 B
streaming-pg-5432 20251215T221149 - Mon Dec 15 22:11:50 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB
streaming-pg-5432 20251215T221047 - Mon Dec 15 22:10:47 2025 - Size: 45.6 MiB - WAL Size: 32.0 MiB


neha.korukula@barman-backup-node:~$ sudo -iu barman barman recover streaming-pg-5432 20251215T221047 /var/lib/postgresql/16/test_restore --remote-ssh-command "ssh postgres@10.30.50.91" --target-time "2025-12-15 23:13:53.866517+00:00" --get-wal
Starting remote restore for server streaming-pg-5432 using backup 20251215T221047
Destination directory: /var/lib/postgresql/16/test_restore
Remote command: ssh postgres@10.30.50.91
Doing PITR. Recovery target time: '2025-12-15 23:13:53.866517+00:00'
Copying the base backup.
Generating recovery configuration
Identify dangerous settings in destination directory.

WARNING
The following configuration files have not been saved during backup, hence they have not been restored.
You need to manually restore them in order to start the recovered PostgreSQL instance:

    postgresql.conf
    pg_hba.conf
    pg_ident.conf

WARNING: 'get-wal' is in the specified 'recovery_options'.
Before you start up the PostgreSQL server, please review the postgresql.auto.conf file
inside the target directory. Make sure that 'restore_command' can be executed by the PostgreSQL user.

Recovery completed (start time: 2025-12-15 23:57:42.757175+00:00, elapsed time: 7 seconds)
Your PostgreSQL server has been successfully prepared for recovery!

postgres@barman-db-node:~/16/test_restore$ cat /var/lib/postgresql/16/test_restore/postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.

# The 'barman-wal-restore' command is provided in the 'barman-cli' package
restore_command = 'barman-wal-restore -P -U barman barman-backup-node streaming-pg-5432 %f %p'
recovery_target_time = '2025-12-15 23:13:53.866517+00:00'

Error:
postgres@barman-db-node:~$ /usr/lib/postgresql/16/bin/pg_ctl start -D /var/lib/postgresql/16/test_restore
waiting for server to start....2025-12-16 00:33:36.462 GMT [58039] LOG:  could not stat file "/var/lib/postgresql/16/test_restore/conf.d/barman.conf": Too many levels of symbolic links
2025-12-16 00:33:36.462 GMT [58039] FATAL:  configuration file "/var/lib/postgresql/16/test_restore/postgresql.conf" contains errors
 stopped waiting
pg_ctl: could not start server
Examine the log output.

To be continued!!!!
==================================
Recover all available data:
==================================
Barman with automatic cluster management tools (Patroni/repmgr):
